@page
@model FoodioClient.Pages.Admin.StatisticsModel
@{
    Layout = "_AdminLayout";
    ViewData["Title"] = "Thống kê";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
    #usersTable th,
    #usersTable td {
        color: #f8f9fa !important; /* Màu chữ đen tự nhiên */
    }

    #usersTable thead th {
        background-color: #f8f9fa;
        font-weight: 600;
    }
</style>
<main class="main-wrapper">
    <div class="main-content">
        <div class="container-fluid py-4">
            <h3 class="mb-4">Thống kê Hệ thống</h3>

            <div class="card mb-4">
                <div class="card-body row g-2">
                    <div class="col-md-3">
                        <label class="form-label">Ngày bắt đầu</label>
                        <input type="date" class="form-control" id="startDate" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Ngày kết thúc</label>
                        <input type="date" class="form-control" id="endDate" />
                    </div>
                    <div class="col-md-2 d-grid align-items-end">
                        <button class="btn btn-primary mt-4" id="btnLoad">Tải dữ liệu</button>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-6 mb-4">
                    <div class="card"><div class="card-header">Doanh thu theo loại đơn</div><div class="card-body"><canvas id="orderTypeChart"></canvas></div></div>
                </div>
                <div class="col-lg-6 mb-4">
                    <div class="card"><div class="card-header">Top người dùng</div><div class="card-body"><canvas id="userChart"></canvas></div></div>
                </div>
                <div class="col-12">
                    <div class="card"><div class="card-header">Doanh thu theo thời gian</div><div class="card-body"><canvas id="timeChart"></canvas></div></div>
                </div>
            </div>
        </div>

    </div>
</main>

@await Html.PartialAsync("_ToastrScripts")

<script>
const statsApi="/api/admin/statistics";
const token=localStorage.getItem('access_token');
let orderTypeChart,userChart,timeChart;

document.getElementById('btnLoad').addEventListener('click',loadStats);

function buildChart(ctx,label,data){
  return new Chart(ctx,{type:'bar',data:{labels:label,datasets:[{data,backgroundColor:'#0d6efd'}]},options:{plugins:{legend:{display:false}}}});
}

async function loadStats(){
  const sd=document.getElementById('startDate').value;
  const ed=document.getElementById('endDate').value;
  const qs=new URLSearchParams(); if(sd)qs.append('startDate',sd); if(ed)qs.append('endDate',ed);

  // order type
  const res1=await fetch(`${statsApi}/revenue/by-order-type?${qs}`,{headers:{Authorization:`Bearer ${token}`}}); const orderTypes=await res1.json();
  const labels1=orderTypes.map(o=>o.orderTypeName); const data1=orderTypes.map(o=>o.totalRevenue);
  orderTypeChart?.destroy(); orderTypeChart=buildChart(document.getElementById('orderTypeChart'),labels1,data1);

  // top users
  const res2=await fetch(`${statsApi}/top-users?top=5&${qs}`,{headers:{Authorization:`Bearer ${token}`}}); const users=await res2.json();
  const labels2=users.map(u=>u.userName); const data2=users.map(u=>u.totalRevenue);
  userChart?.destroy(); userChart=buildChart(document.getElementById('userChart'),labels2,data2);

  // revenue by time
  const res3=await fetch(`${statsApi}/revenue/by-time?${qs}`,{headers:{Authorization:`Bearer ${token}`}}); const times=await res3.json();
  const labels3=times.map(t=>t.date.split('T')[0]); const data3=times.map(t=>t.totalRevenue);
  timeChart?.destroy(); timeChart=new Chart(document.getElementById('timeChart'),{type:'line',data:{labels:labels3,datasets:[{label:'Doanh thu',data:data3,fill:true,borderColor:'#0d6efd',backgroundColor:'rgba(13,110,253,.2)'}]}});
}

loadStats();
</script> 