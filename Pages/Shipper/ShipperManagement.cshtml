@page
@model FoodieAPII.Pages.Shipper.ShipperManagementModel
@{
    ViewData["HideLayoutHeader"] = true;
}

<body>
    <div class="container mt-5">
        <h1 class="text-center mb-4">Quản lý Đơn Hàng - Shipper</h1>

        <!-- Thanh điều hướng -->
        <div class="row justify-content-center">
            <div class="col-8">
                <nav class="nav-container p-3 border rounded">
                    <nav class="nav nav-pills justify-content-center">
                        <a class="nav-link active" href="javascript:void(0);" onclick="showSection('item-1')">Đơn Chờ Giao</a>
                        <a class="nav-link" href="javascript:void(0);" onclick="showSection('item-2')">Cập Nhật Trạng Thái</a>
                        <a class="nav-link" href="javascript:void(0);" onclick="showSection('item-3')">Lịch Sử Giao Hàng</a>
                        <a class="nav-link" href="javascript:void(0);" onclick="showSection('item-4')">Màn Tổng Thu</a>
                    </nav>
                </nav>
            </div>
        </div>

        <!-- Nội dung -->
        <div class="row mt-4">
            <div class="col-12">
                <!-- Đơn Chờ Giao -->
                <div id="item-1" class="section-content">
                    <h4>Đơn Chờ Giao</h4>
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Tên Khách</th>
                                <th>Món</th>
                                <th>Phí Ship</th>
                                <th>Tổng Tiền Món</th>
                                <th>Hành Động</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr data-name="Nguyễn Văn A" data-fee="15000" data-totalprice="50000">
                                <td>1</td>
                                <td>Nguyễn Văn A</td>
                                <td>Trà sữa x1</td>
                                <td>15.000đ</td>
                                <td>50.000đ</td>
                                <td>
                                    <button class="btn btn-sm btn-success" onclick="startDelivery(this)">Nhận giao hàng</button>
                                    <button class="btn btn-sm btn-primary" onclick="updateOrderStatus('DH001', this)">Cập Nhật Trạng Thái</button>
                                </td>
                            </tr>
                            <tr data-name="Trần Thị B" data-fee="20000" data-totalprice="70000">
                                <td>2</td>
                                <td>Trần Thị B</td>
                                <td>Bánh mì x2</td>
                                <td>20.000đ</td>
                                <td>70.000đ</td>
                                <td>
                                    <button class="btn btn-sm btn-success" onclick="startDelivery(this)">Nhận giao hàng</button>
                                    <button class="btn btn-sm btn-primary" onclick="updateOrderStatus('DH002', this)">Cập Nhật Trạng Thái</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Cập Nhật Trạng Thái -->
                <div id="item-2" class="section-content" style="display:none;">
                    <h4>Cập Nhật Trạng Thái</h4>
                    <input type="text" id="order-id" class="form-control" placeholder="Mã đơn hàng" readonly>
                    <select id="order-status" class="form-select mt-2">
                        <option value="completed">Đã giao</option>
                        <option value="failed">Thất bại</option>
                    </select>
                    <textarea id="failure-reason" class="form-control mt-2" rows="2" placeholder="Lý do thất bại (nếu có)"></textarea>
                    <button class="btn btn-primary mt-2" onclick="confirmUpdateStatus()">Cập Nhật Trạng Thái</button>
                </div>

                <!-- Lịch Sử Giao Hàng -->
                <div id="item-3" class="section-content" style="display:none;">
                    <h4>Lịch Sử Giao Hàng</h4>
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Mã Đơn</th>
                                <th>Ngày Giao</th>
                                <th>Khách Hàng</th>
                                <th>Tổng Tiền Món</th>
                                <th>Tiền Ship</th>
                                <th>Trạng Thái</th>
                            </tr>
                        </thead>
                        <tbody id="history-body"></tbody>
                    </table>
                </div>

                <!-- Màn Tổng Thu -->
                <div id="item-4" class="section-content" style="display:none;">
                    <h4 class="text-center mb-3">Màn Tổng Thu</h4>
                    <div class="summary-box mx-auto p-3">
                        <p><strong>Tổng Tiền Món Ăn:</strong> <span id="total-food">0</span> đ</p>
                        <p><strong>Tổng Tiền Ship:</strong> <span id="total-shipping">0</span> đ</p>
                        <p><strong>Số Đơn Thành Công:</strong> <span id="total-orders">0</span></p>
                        <button class="btn btn-info w-100 mt-2" onclick="calcTotal()">Tính Lại Tổng</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentRow = null;
        let totalOrders = 0;
        let totalShipping = 0;
        let totalFood = 0;

        function startDelivery(btn) {
            btn.innerText = 'Đang giao';
            btn.disabled = true;
        }

        function updateOrderStatus(orderId, btn) {
            document.getElementById('order-id').value = orderId;
            currentRow = btn.closest('tr');
            showSection('item-2');
        }

        function confirmUpdateStatus() {
            const orderId = document.getElementById('order-id').value;
            const status = document.getElementById('order-status').value;
            const name = currentRow.dataset.name;
            const fee = parseInt(currentRow.dataset.fee);
            const foodPrice = parseInt(currentRow.dataset.totalprice);
            const date = new Date().toLocaleString();

            // Thêm vào lịch sử
            const historyBody = document.getElementById('history-body');
            const index = historyBody.children.length + 1;
            historyBody.innerHTML += `
                <tr>
                    <td>${index}</td>
                    <td>${orderId}</td>
                    <td>${date}</td>
                    <td>${name}</td>
                    <td>${foodPrice} đ</td>
                    <td>${fee} đ</td>
                    <td>${status === 'completed' ? 'Đã giao' : 'Thất bại'}</td>
                </tr>
            `;

            // Tính tổng
            if (status === 'completed') {
                totalOrders++;
                totalShipping += fee;
                totalFood += foodPrice;
            }

            showSection('item-3');
        }

        function calcTotal() {
            document.getElementById('total-orders').innerText = totalOrders;
            document.getElementById('total-shipping').innerText = totalShipping;
            document.getElementById('total-food').innerText = totalFood;
        }

        function showSection(id) {
            document.querySelectorAll('.section-content').forEach(sec => sec.style.display = 'none');
            document.getElementById(id).style.display = 'block';
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            if (id === 'item-1') document.querySelectorAll('.nav-link')[0].classList.add('active');
            if (id === 'item-2') document.querySelectorAll('.nav-link')[1].classList.add('active');
            if (id === 'item-3') document.querySelectorAll('.nav-link')[2].classList.add('active');
            if (id === 'item-4') document.querySelectorAll('.nav-link')[3].classList.add('active');
        }

        document.addEventListener('DOMContentLoaded', () => showSection('item-1'));
    </script>
</body>

<style>
    .summary-box {
        width: 300px; /* Chiều ngang gọn dễ nhìn */
        background-color: #f8f9fa;
        border: 2px solid #ddd;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        text-align: left;
    }

    .nav-container {
        border: 2px solid #ddd;
        border-radius: 8px;
        background-color: #fff;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }

    .nav-pills .nav-link {
        font-weight: 600;
        padding: 12px 20px;
        margin-right: 10px;
        color: #007bff;
    }

        .nav-pills .nav-link.active {
            background-color: #007bff;
            color: white;
        }

    .bg-light {
        background-color: #f8f9fa !important;
    }
</style>
